はい、この動画で解説されているコードを実装するための設計書を作成します。この設計書は、プロジェクトの構造、主要な機能、使用技術、データフローなどを網羅し、実装の指針となることを目的としています。

---

## ギャラリープロジェクト設計書

### 1. 概要

本プロジェクトは、HTML、CSS、JavaScript、およびGSAP（GreenSock Animation Platform）を使用して、**円形に配置されたインタラクティブな3D画像ギャラリー**を実装することを目的とします。ユーザーがカーソルを画像の上に移動させると、ホバーアニメーション（自身と周辺の画像が3Dで反転）が発生し、クリックするとギャラリー全体がズームイン・回転して、クリックされた画像が中央に表示され、関連するタイトルがアニメーション表示されます。また、マウスの動きに合わせてギャラリー全体がわずかに傾く視差効果（パララックスエフェクト）も実装します。

**主要機能**:
*   **円形画像ギャラリー**: 複数枚の画像を円形に配置。
*   **ホバーアニメーション**: マウスカーソルが画像に近づくと、その画像と周辺の画像が3Dで反転・拡大し、わずかに円から押し出される。
*   **クリック時のプレビューモード**:
    *   クリックされた画像がギャラリーの中央にズームイン・回転して配置される。
    *   関連するタイトルが画面下部からアニメーション表示される。
    *   プレビューモードから抜ける際は、ギャラリーが元の状態に戻り、タイトルが非表示になる。
*   **視差効果（パララックスエフェクト）**: マウスの動きに合わせてギャラリー全体が傾き、奥行き感を演出。
*   **レスポンシブデザイン**: ウィンドウサイズに応じてギャラリーのスケールを調整。
*   **スムーズなアニメーション**: GSAPと線形補間（lerping）により、すべてのインタラクションとアニメーションを滑らかに実行。

**使用技術**:
*   HTML5
*   CSS3
*   JavaScript (ES6+)
*   **GSAP (GreenSock Animation Platform)**: アニメーションライブラリ。
*   **GSAP SplitTextプラグイン**: テキストを単語単位でアニメーションさせるために使用。

### 2. システムアーキテクチャ

プロジェクトは以下の主要なファイルとコンポーネントで構成されます。

*   **`index.html`**: ページの基本構造を定義する。
*   **`style.css`**: レイアウトとスタイリング、3D変換の有効化、レスポンシブな調整を記述する。
*   **`collection.js`**: ギャラリーアイテムのデータ（タイトルと画像パス）をJavaScriptオブジェクトの配列としてエクスポートする。
*   **`main.js`**: メインのJavaScriptロジック。DOM操作、イベントリスナー、GSAPアニメーション制御、データ処理、描画ループなどを担当する。

```
Project Root/
├── index.html
├── style.css
├── js/
│   ├── collection.js
│   └── main.js
└── assets/
    └── images/ (画像ファイル)
```

### 3. モジュール構成と役割

#### 3.1 `index.html`

*   **`<nav>`**: ページのトップに配置されるシンプルなナビゲーション（プレースホルダーリンクとテキスト）。
*   **`<main container>`**: ギャラリー全体を保持する主要なコンテナ。
    *   **`<div class="outer-wrapper">`**: ギャラリーの外側のラッパー。マウス移動時の**微妙な視差効果**を実現するために使用。
        *   **`<div class="gallery">`**: ギャラリーの本体。**ズームと回転**のアニメーションを処理する。JavaScriptで画像カードが動的に追加されるため、初期状態は空。
    *   **`<div class="title-container">`**: 画像がクリックされたときにタイトルを表示するためのコンテナ。
*   **`<footer>`**: ページの最下部に配置されるシンプルなフッター（プレースホルダーテキスト）。

#### 3.2 `style.css`

*   **リセットCSS**: 全ての要素の`margin`、`padding`、`box-sizing`をリセットし、ブラウザ間の表示の一貫性を確保。
*   **`body`**: 背景色、フォントなどの基本スタイル。
*   **基本スタイル**: `a`タグや`p`タグのフォントサイズ、ウェイト、文字間隔などを設定。
*   **`img`**: `object-fit: cover`で画像が適切にスケーリングされ、`backface-visibility: hidden`で3D変換時の表示を調整。
*   **レイアウト**:
    *   `nav`と`footer`は`absolute positioned`で全幅にストレッチされ、`flexbox`でコンテンツを配置。
    *   メインの`container`はビューポートの幅と高さいっぱいを占め、`overflow: hidden`でギャラリーアニメーションがコンテナ内に収まるようにする。
    *   `gallery container`は全サイズで、`perspective`と`3D transforms`が有効化され、奥行きと視差効果を可能にする。
    *   `gallery`自体は固定サイズで中央に配置され、画像カードを保持する。
    *   各`card`は`absolute positioned`で比較的小さく、`3D transform styles`が適用され、`border-radius`と`overflow: hidden`でスタイリングされる。
*   **タイトルコンテナ**: `fixed`で画面の下部中央に配置され、`clip-path: polygon`で切り抜かれ、タイトルアニメーションのためのエリアを確保。
*   **タイトルテキスト**: `p`タグは中央揃えで、大きなフォントサイズと狭い文字間隔でスタイル設定される。
*   **`word`クラス**: SplitTextプラグインによってタイトル内の各単語に動的に追加されるクラス。

#### 3.3 `collection.js`

*   ギャラリーに表示するアイテムのデータをエクスポートするファイル。
*   各アイテムは、**`title` (文字列)**と**`imagePath` (文字列)**を含むオブジェクトとして定義される。

```javascript
// collection.js
export default [
    { title: "美しい風景", imagePath: "assets/images/landscape.jpg" },
    { title: "歴史的建造物", imagePath: "assets/images/architecture.jpg" },
    // ... 他の画像アイテム
];
```

#### 3.4 `main.js`

メインスクリプトは、以下の順序で処理を実行します。

1.  **インポート**: `collection.js`からの画像コレクション、GSAP本体、およびSplitTextプラグインをインポートする。
2.  **初期設定**:
    *   `DOMContentLoaded`イベント発生後、SplitTextプラグインをGSAPに登録する。
    *   DOMから主要な要素（`gallery`、`galleryContainer`、`titleContainer`）を取得する。
    *   以下の変数を設定する:
        *   `cards`: 生成された全てのカード要素を格納する配列。
        *   `transformState`: 各カードの現在および目標の回転、位置、オフセット、スケール、角度を追跡するオブジェクト。
        *   `flags`: アニメーションの進行状況やプレビューモードの状態を制御するためのブール値フラグ（例: `previewActive`, `transitioning`）。
        *   `config`: ギャラリーの動作を定義する設定オブジェクト（例: `numberOfImages`, `cardRadius`, `hoverSensitivity`, `lerpFactor`）。
        *   `parallaxState`: ギャラリー全体の傾き（視差効果）の目標と現在のX, Y, Z回転値を管理するオブジェクト。
3.  **カードの動的生成と配置**:
    *   `config.numberOfImages`に基づいてループ処理を実行。
    *   各カードについて、円周上の配置角度と、それに基づくX, Y座標を三角関数（`Math.cos`, `Math.sin`）を使用して計算する。座標は`config.cardRadius`によって中心からの距離が決まる。
    *   新しい`card`要素と`img`要素を作成し、クラス、ユニークなインデックス、対応するタイトル、画像ソースを割り当てる。
    *   **GSAP**を使用して、計算されたX, Y座標と回転角（中心から外側を向くように）でカードを画面に配置する。
    *   カードを`galleryContainer`に追加し、`cards`配列に格納する。同時に、そのカードのアニメーション関連値（`rotation`, `position`, `offset`, `scale`, `angle`）を`transformState`に保存する。
    *   各カードにクリックイベントリスナーを追加する。
4.  **クリックイベント処理 (`togglePreview` 関数)**:
    *   カードがクリックされ、かつアニメーション中でない場合にこの関数が呼び出される。
    *   `previewActive`フラグと`transitioning`フラグを設定し、重複アニメーションを防ぐ。
    *   クリックされたカードの角度と、目標の画面下部中央の位置（`3π/2`ラジアン）を取得する。
    *   ギャラリー全体がクリックされたカードを中央に配置するために必要な最短回転量を計算する。
    *   全てのアニメーションを開始する前に、すべてのカードの既存のスケール、回転、移動をリセットする。
    *   **GSAP**を使用して、ギャラリー全体をスケールアップ、下方に移動、および計算された量だけ回転させ、クリックされたカードを中央に持ってくる。
    *   同時に、視差モーションをリセットするため、ギャラリーのX, Y, Z軸の回転をゼロにアニメートする。
    *   クリックされたカードのタイトルを取得し、新しいテキスト要素を作成して`titleContainer`に追加する。
    *   **SplitTextプラグイン**でタイトルを個々の単語に分割し、画面外に配置した後、わずかな遅延とスタッガー効果を付けて上方にアニメートして表示する。
5.  **プレビューのリセット処理**:
    *   ユーザーがプレビューモード中にギャラリーの外側をクリックしたときにトリガーされる。
    *   `transitioning`フラグを確認し、アニメーション中の二重起動を防ぐ。
    *   表示されているタイトルがある場合、**SplitText**で分割された単語を上方にアニメートして画面外に移動させ、アニメーション完了後にDOMから削除する。
    *   ビューポートの幅に基づいて、ギャラリーをスケールダウンする量を決定する（レスポンシブ対応）。
    *   **GSAP**でギャラリーを元の位置、スケール、回転に戻すアニメーションを実行する。
    *   アニメーション完了後、すべてのフラグと視差関連の値をリセットし、ギャラリーをデフォルト状態に戻す。
6.  **ウィンドウリサイズ処理 (`handleResize` 関数)**:
    *   ウィンドウがリサイズされたときにトリガーされる。
    *   現在の画面幅をチェックし、デバイスがモバイル（例: 1000px未満）であるかどうかのフラグを更新する。
    *   ビューポートの幅に基づいてギャラリーのスケールを調整し、**GSAP**でギャラリーに直接適用することで、画像が画面からはみ出さないようにする。
    *   プレビューモードでない場合、`parallaxState`と各カードの`transformState`（回転、スケール、移動など）をリセットする。
    *   `window.resize`イベントリスナーにこの関数を登録し、ページロード時にも一度実行する。
7.  **マウスムーブイベント処理 (視差効果とホバー効果)**:
    *   ドキュメント全体の`mousemove`イベントリスナー。
    *   プレビューモード中、アニメーション中、またはモバイルデバイスの場合は処理をスキップする。
    *   **視差効果**:
        *   マウスの位置を画面中央からの相対的なX, Y座標（-1から1の範囲のパーセンテージ）に変換する。
        *   これらのパーセンテージを使用して、ギャラリー全体のX, Y, Z軸の目標回転値を更新し、わずかな傾きを生成する。
    *   **ホバー効果**:
        *   各カードに対し、マウスからカード中心までの距離を計算する。
        *   `config.hoverSensitivity`で定義されたしきい値に基づき、マウスが十分に近づいているか判定する。
        *   近づいている場合、距離に応じて`flip factor`を計算し、カードに3D回転、スケール増加、円からのわずかな押し出し（カードの元の角度を使用）のアニメーションを適用する。
        *   マウスがカードから離れるか、遠すぎる場合、これらのプロパティをリセットする。
8.  **アニメーションループ (`animate` 関数)**:
    *   `requestAnimationFrame`を使用して、継続的に実行されるメインのアニメーションループ。
    *   プレビューモード中またはトランジション中の場合、他のアニメーションと干渉しないよう更新を一時停止する。
    *   **ギャラリーの回転**: `parallaxState`の`current`X, Y, Z値を`target`値に線形補間（lerp）し、**GSAP**で`galleryContainer`に適用することで、スムーズな視差効果を実現する。
    *   **各カードのアニメーション**:
        *   各カードの`transformState`（回転、スケール、オフセットなど）の`current`値を`target`値に線形補間（lerp）で更新する。これにより、瞬間的な変化ではなく、自然な動きが生まれる。
        *   カードの円形上の位置を再計算し、ホバー効果によるオフセットを適用する。
        *   **GSAP**を使用して、カードの現在の位置、回転、スケールを更新し、3Dパースペクティブを維持する。
    *   ループの最後に`requestAnimationFrame(animate)`を呼び出し、次フレームでの更新をスケジュールする。

### 4. データ構造

*   **`collection.js`のデータ**:
    ```javascript
    export default [
        { title: "Image Title 1", imagePath: "path/to/image1.jpg" },
        { title: "Image Title 2", imagePath: "path/to/image2.jpg" },
        // ...
    ];
    ```
*   **`config`オブジェクト**:
    ```javascript
    const config = {
        numberOfImages: 8,      // ギャラリーに表示する画像の総数
        cardRadius: 200,        // カードが円の中心からどれだけ離れるか (px)
        hoverSensitivity: 50,   // ホバー効果の感度 (マウスからカード中心までの距離)
        cardHoverMoveScale: {   // ホバー時のカードの移動・スケール量
            x: 20, y: 20, scale: 1.2, rotationY: 20
        },
        lerpFactor: 0.1         // スムーズなアニメーションのための線形補間係数
    };
    ```
*   **`transformState` (各カード用)**:
    ```javascript
    // cards配列内の各要素に対応するオブジェクト
    {
        current: {
            rotation: { x: 0, y: 0, z: 0 },
            position: { x: 0, y: 0 },
            offset: { x: 0, y: 0 },
            scale: 1
        },
        target: {
            rotation: { x: 0, y: 0, z: 0 },
            position: { x: 0, y: 0 },
            offset: { x: 0, y: 0 },
            scale: 1
        },
        angle: 0 // カードの初期配置角度 (ラジアン)
    }
    ```
*   **`parallaxState` (ギャラリー全体用)**:
    ```javascript
    {
        target: { x: 0, y: 0, z: 0 }, // マウス位置に基づく目標回転値
        current: { x: 0, y: 0, z: 0 } // 現在の回転値 (線形補間によりtargetに近づく)
    }
    ```

### 5. 実装上の留意点

*   **3D変換の有効化**: CSSで`perspective`プロパティと`transform-style: preserve-3d`を適切に設定することで、HTML要素が3D空間でアニメーションできるようにする。
*   **線形補間 (Lerping)**: `requestAnimationFrame`ループ内で線形補間を使用して、目標値に向かって値を徐々に変化させることで、アニメーションの動きを滑らかで自然にする。
*   **イベントハンドリングの制御**: `transitioning`や`previewActive`といったフラグを適切に管理することで、ユーザーの操作がアニメーションと衝突したり、予期せぬ動作を引き起こしたりするのを防ぐ。
*   **レスポンシブデザイン**: `handleResize`関数で画面幅に応じたギャラリーのスケール調整を行うことで、様々なデバイスでの見栄えを確保する。
*   **パフォーマンス最適化**: `requestAnimationFrame`を使用することで、ブラウザの描画サイクルに合わせてアニメーションが実行され、スムーズなパフォーマンスが実現される。マウスムーブイベントのような高頻度で発生するイベントでは、不必要な処理をスキップする条件分岐を設けることで、パフォーマンスへの影響を最小限に抑える。
*   **データとロジックの分離**: `collection.js`で画像データを分離することで、コードの整理と再利用性を高める。

---

## 修正履歴

### 2025-09-21: モーダル表示の修正

**問題：**
- モーダルのポップアップ時に不要な縮小・回転アニメーションが発生
- モーダルが傾いたまま表示される
- リロード後の初回と2回目以降でモーダルの表示拡大率が異なる

**修正内容：**
1. **`openModal()` メソッドの初期設定を修正** (`gallery-viewer.js:322-329`)
   ```javascript
   gsap.set('.modal-content', {
       opacity: 0,
       scale: 1,        // 追加: 拡大率の統一
       rotation: 0,     // 追加: 回転リセット
       x: '-50%',
       y: '-50%',
       xPercent: 0,
       yPercent: 0
   });
   ```

2. **アニメーション処理の簡素化** (`gallery-viewer.js:337-343`)
   - 縮小・回転動作を削除
   - シンプルなフェードインアニメーションに変更
   ```javascript
   .to('.modal-content', {
       opacity: 1,
       x: '-50%',
       y: '-50%',
       duration: 0.3,
       ease: "power2.out"
   }, "-=0.1");
   ```

**解決された問題：**
- モーダルが常に正常なサイズ（scale: 1）で表示
- 傾きがない状態（rotation: 0）で表示
- 初回と2回目以降の表示が統一

### 2025-09-21: パスインタラクション機能の実装

**新機能：**
- パスクリックによる状態サイクル変更
- パスホバー時の視覚的フィードバック
- グラフアイテムホバー時の接続パス一括ハイライト

**実装内容：**

1. **パス状態管理システム** (`gallery-viewer.js:217`)
   ```javascript
   this.connectionLines.push({
       element: pathElement,
       from: index1,
       to: index2,
       state: 0  // 0=ピンク実線, 1=緑実線, 2=薄い透明
   });
   ```

2. **パスクリック機能** (`gallery-viewer.js:388-398`)
   - 状態サイクル：ピンク実線 → 緑実線 → 薄い透明 → ピンク実線
   - 透明状態でもパス要素は保持（再表示処理の効率化）

3. **パス状態別スタイル** (`gallery-viewer.js:401-437`)
   ```javascript
   switch(lineData.state) {
       case 0: // ピンク実線 + 不透明
           element.style.stroke = '#ff6b6b';
           opacity: 0.8;
       case 1: // 緑実線 + 不透明
           element.style.stroke = '#00ff00';
           opacity: 0.8;
       case 2: // ピンク実線 + 薄い透明
           element.style.stroke = '#ff6b6b';
           opacity: 0.15;
   }
   ```

4. **パスホバーアニメーション** (`gallery-viewer.js:440-459`)
   - マウスオーバー：太さ5 → 8、カーソル変化
   - マウスアウト：太さ8 → 5に復元
   - GSAPによるスムーズなアニメーション

5. **グラフアイテム連動ホバー** (`gallery-viewer.js:269-304`)
   - アイテムホバー時：接続パスが一括で太さ8にハイライト
   - 状態別透明度制御：
     - 状態0,1：完全ハイライト（opacity: 1）
     - 状態2：薄いハイライト（opacity: 0.3）
   - ホバー終了時：各パスの状態に応じた適切な透明度に復元

**技術的改善：**
- CSSとJavaScriptの優先度問題を解決（`element.style`使用）
- パス太さの統一：基本5px、ホバー時8px
- 状態保持による一貫したユーザー体験

**ユーザビリティ向上：**
- パスクリック範囲拡大（太さ3→5px）
- 視覚的フィードバックの強化
- 直感的な状態サイクル操作

---

この設計書は、動画で解説されている主要な概念と実装方法に基づいて構成されています。各セクションの詳細な実装は、動画の具体的な手順とコード例を参照してください。